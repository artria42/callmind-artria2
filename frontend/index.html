<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Miramed CallMind ‚Äî –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∑–≤–æ–Ω–∫–æ–≤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        *{font-family:'Inter',sans-serif}
        .fade-in{animation:fadeIn .3s ease-out}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .nav-active{background:linear-gradient(to right,#0891b2,#06b6d4);color:#fff;box-shadow:0 10px 15px -3px rgba(8,145,178,.3)}
        .nav-inactive{color:#94a3b8}
        .nav-inactive:hover{background:rgba(51,65,85,.5);color:#fff}
        .modal{display:none;position:fixed;inset:0;z-index:100;align-items:center;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(4px)}
        .modal.active{display:flex}
        .filter-btn.active{background:#0891b2;color:#fff}
        .filter-btn:not(.active){background:#f1f5f9;color:#64748b}
        .clickable:hover{transform:translateY(-2px);box-shadow:0 10px 25px -5px rgba(0,0,0,.1)}
        .transcript-manager{background:#dcfce7;border-left:4px solid #22c55e;margin-left:0;margin-right:20%}
        .transcript-client{background:#dbeafe;border-left:4px solid #3b82f6;margin-left:20%;margin-right:0}
        .expandable{max-height:0;overflow:hidden;transition:max-height 0.3s ease-out}
        .expandable.open{max-height:1000px}
        .expand-btn{cursor:pointer;user-select:none}
        .expand-btn:hover{background:#f1f5f9}
    </style>
</head>
<body class="bg-slate-50">

<script>
    // ‚ö†Ô∏è –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ URL –≤–∞—à–µ–≥–æ Railway –±—ç–∫–µ–Ω–¥–∞
    const API_URL = 'https://callmind-artria2-production.up.railway.app';
</script>

<div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="hidden lg:flex w-72 bg-gradient-to-b from-slate-900 via-slate-800 to-slate-900 text-white flex-col min-h-screen fixed h-full z-40">
        <div class="p-6 border-b border-slate-700/50">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-cyan-500 to-teal-600 rounded-xl flex items-center justify-center shadow-lg">
                    <i data-lucide="stethoscope" class="w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold">Miramed</h1>
                    <span class="text-xs text-cyan-400 font-medium">CallMind AI v2</span>
                </div>
            </div>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <button onclick="showScreen('dashboard')" id="nav-dashboard" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl nav-active">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                <span class="font-medium">–î–∞—à–±–æ—Ä–¥</span>
            </button>
            <button onclick="showScreen('calls')" id="nav-calls" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl nav-inactive">
                <i data-lucide="phone-call" class="w-5 h-5"></i>
                <span class="font-medium">–ó–≤–æ–Ω–∫–∏</span>
            </button>
            <button onclick="showScreen('team')" id="nav-team" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl nav-inactive">
                <i data-lucide="users" class="w-5 h-5"></i>
                <span class="font-medium">–ö–æ–º–∞–Ω–¥–∞</span>
            </button>
            <button onclick="showScreen('whatsapp')" id="nav-whatsapp" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl nav-inactive opacity-50">
                <i data-lucide="message-circle" class="w-5 h-5"></i>
                <span class="font-medium">WhatsApp</span>
                <span class="ml-auto text-xs bg-slate-700 px-2 py-0.5 rounded">—Å–∫–æ—Ä–æ</span>
            </button>
        </nav>
        <div class="p-4 border-t border-slate-700/50">
            <div class="flex items-center gap-2 p-2 rounded-lg bg-cyan-500/20 border border-cyan-500/30">
                <i data-lucide="zap" class="w-4 h-4 text-cyan-400"></i>
                <span class="text-xs text-cyan-400 font-medium">AI v2 –ê–∫—Ç–∏–≤–µ–Ω</span>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 lg:ml-72 overflow-auto min-h-screen pb-20 lg:pb-0">
        <!-- Mobile Header -->
        <div class="lg:hidden sticky top-0 z-30 bg-white border-b border-slate-200 px-4 py-3">
            <div class="flex items-center justify-center gap-2">
                <div class="w-8 h-8 bg-gradient-to-br from-cyan-500 to-teal-600 rounded-lg flex items-center justify-center">
                    <i data-lucide="stethoscope" class="w-5 h-5 text-white"></i>
                </div>
                <span class="font-bold text-slate-800">Miramed CallMind</span>
            </div>
        </div>

        <!-- ==================== DASHBOARD ==================== -->
        <div id="screen-dashboard" class="screen p-4 lg:p-8 space-y-6 fade-in">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                <div>
                    <h1 class="text-2xl lg:text-3xl font-bold text-slate-800">–î–∞—à–±–æ—Ä–¥</h1>
                    <p class="text-slate-500 mt-1">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∑–≤–æ–Ω–∫–æ–≤ Miramed (–ê–∫—Ç–æ–±–µ)</p>
                </div>
            </div>

            <!-- Filters -->
            <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100">
                <div class="flex flex-col lg:flex-row gap-4">
                    <div class="flex-1">
                        <label class="text-xs font-medium text-slate-500 mb-2 block">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</label>
                        <select id="filter-manager" onchange="applyFilters()" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm font-medium text-slate-700">
                            <option value="all">–í—Å–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <label class="text-xs font-medium text-slate-500 mb-2 block">–ü–µ—Ä–∏–æ–¥</label>
                        <select id="filter-period" onchange="setPeriod(this.value)" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm font-medium text-slate-700">
                            <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
                            <option value="yesterday">–í—á–µ—Ä–∞</option>
                            <option value="current_week" selected>–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è</option>
                            <option value="last_7_days">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</option>
                            <option value="current_month">–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</option>
                            <option value="last_30_days">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-2 lg:grid-cols-5 gap-4">
                <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100">
                    <div class="w-11 h-11 rounded-xl bg-gradient-to-br from-cyan-500 to-cyan-600 flex items-center justify-center text-white mb-3">
                        <i data-lucide="phone-call" class="w-5 h-5"></i>
                    </div>
                    <p class="text-slate-500 text-xs font-medium">–í—Å–µ–≥–æ –∑–≤–æ–Ω–∫–æ–≤</p>
                    <p class="text-2xl font-bold text-slate-800" id="stat-total-calls">‚Äî</p>
                </div>

                <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100">
                    <div class="w-11 h-11 rounded-xl bg-gradient-to-br from-violet-500 to-violet-600 flex items-center justify-center text-white mb-3">
                        <i data-lucide="brain" class="w-5 h-5"></i>
                    </div>
                    <p class="text-slate-500 text-xs font-medium">–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ</p>
                    <p class="text-2xl font-bold text-violet-600" id="stat-analyzed">‚Äî</p>
                </div>

                <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100 cursor-pointer clickable" onclick="showScoreDetail()">
                    <div class="w-11 h-11 rounded-xl bg-gradient-to-br from-emerald-500 to-emerald-600 flex items-center justify-center text-white mb-3">
                        <i data-lucide="star" class="w-5 h-5"></i>
                    </div>
                    <p class="text-slate-500 text-xs font-medium">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</p>
                    <p class="text-2xl font-bold text-emerald-600" id="stat-avg-score">‚Äî</p>
                </div>

                <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100">
                    <div class="w-11 h-11 rounded-xl bg-gradient-to-br from-amber-500 to-amber-600 flex items-center justify-center text-white mb-3">
                        <i data-lucide="calendar-check" class="w-5 h-5"></i>
                    </div>
                    <p class="text-slate-500 text-xs font-medium">–£—Å–ø–µ—à–Ω—ã–µ (80+)</p>
                    <p class="text-2xl font-bold text-amber-600" id="stat-successful">‚Äî</p>
                </div>

                <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100">
                    <div class="w-11 h-11 rounded-xl bg-gradient-to-br from-pink-500 to-pink-600 flex items-center justify-center text-white mb-3">
                        <i data-lucide="clock" class="w-5 h-5"></i>
                    </div>
                    <p class="text-slate-500 text-xs font-medium">–°—Ä. –≤—Ä–µ–º—è –∑–≤–æ–Ω–∫–∞</p>
                    <p class="text-2xl font-bold text-pink-600" id="stat-avg-duration">‚Äî</p>
                </div>
            </div>

            <!-- Criteria Breakdown -->
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100">
                <div class="flex items-center gap-2 mb-4">
                    <div class="w-8 h-8 bg-cyan-100 rounded-lg flex items-center justify-center">
                        <i data-lucide="bar-chart-3" class="w-4 h-4 text-cyan-600"></i>
                    </div>
                    <h2 class="text-lg font-bold text-slate-800">–°—Ä–µ–¥–Ω–∏–µ –±–∞–ª–ª—ã –ø–æ –±–ª–æ–∫–∞–º</h2>
                </div>
                <div id="criteria-breakdown" class="grid grid-cols-2 lg:grid-cols-6 gap-4">
                    <p class="text-center py-4 text-slate-400 col-span-full">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>
            </div>

            <!-- Problem Calls & Recent -->
            <div class="grid lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center">
                                <i data-lucide="alert-triangle" class="w-4 h-4 text-red-600"></i>
                            </div>
                            <h2 class="text-lg font-bold text-slate-800">–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –∑–≤–æ–Ω–∫–∏</h2>
                        </div>
                    </div>
                    <div id="problem-calls" class="space-y-3">
                        <p class="text-center py-4 text-slate-400 text-sm">–ù–µ—Ç –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∑–≤–æ–Ω–∫–æ–≤</p>
                    </div>
                </div>

                <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 bg-violet-100 rounded-lg flex items-center justify-center">
                                <i data-lucide="sparkles" class="w-4 h-4 text-violet-600"></i>
                            </div>
                            <h2 class="text-lg font-bold text-slate-800">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∞–Ω–∞–ª–∏–∑—ã</h2>
                        </div>
                    </div>
                    <div id="recent-analyzed" class="space-y-3">
                        <p class="text-center py-4 text-slate-400 text-sm">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== CALLS ==================== -->
        <div id="screen-calls" class="screen p-4 lg:p-8 space-y-6 hidden fade-in">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-slate-800">–ó–≤–æ–Ω–∫–∏</h1>
                    <p class="text-slate-500 text-sm">–í—Å–µ –∑–≤–æ–Ω–∫–∏ —Å AI-–∞–Ω–∞–ª–∏–∑–æ–º</p>
                </div>
                <button onclick="analyzeAllCalls()" id="btn-analyze-all" class="flex items-center gap-2 px-5 py-2.5 bg-gradient-to-r from-violet-500 to-purple-600 text-white rounded-xl font-medium hover:opacity-90 shadow-lg">
                    <i data-lucide="sparkles" class="w-4 h-4"></i>
                    <span>–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ</span>
                </button>
            </div>

            <!-- Calls Filter -->
            <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 space-y-4">
                <div class="flex flex-wrap items-center gap-4">
                    <span class="text-sm font-medium text-slate-600">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:</span>
                    <select id="calls-filter-manager" onchange="renderFilteredCalls()" class="px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm">
                        <option value="all">–í—Å–µ</option>
                    </select>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button onclick="setCallsFilter('all')" id="filter-all" class="filter-btn px-4 py-2 rounded-lg text-sm font-medium active">–í—Å–µ –∑–≤–æ–Ω–∫–∏</button>
                    <button onclick="setCallsFilter('problem')" id="filter-problem" class="filter-btn px-4 py-2 rounded-lg text-sm font-medium">–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ (&lt;60)</button>
                    <button onclick="setCallsFilter('success')" id="filter-success" class="filter-btn px-4 py-2 rounded-lg text-sm font-medium">–£—Å–ø–µ—à–Ω—ã–µ (80+)</button>
                    <button onclick="setCallsFilter('unanalyzed')" id="filter-unanalyzed" class="filter-btn px-4 py-2 rounded-lg text-sm font-medium">–ë–µ–∑ –∞–Ω–∞–ª–∏–∑–∞</button>
                </div>
            </div>

            <!-- Calls Table -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-slate-50 border-b border-slate-100">
                            <tr>
                                <th class="text-left px-4 py-3 text-xs font-semibold text-slate-500">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</th>
                                <th class="text-left px-4 py-3 text-xs font-semibold text-slate-500">–ü–∞—Ü–∏–µ–Ω—Ç</th>
                                <th class="text-left px-4 py-3 text-xs font-semibold text-slate-500">–î–∞—Ç–∞</th>
                                <th class="text-left px-4 py-3 text-xs font-semibold text-slate-500">–î–ª–∏—Ç.</th>
                                <th class="text-left px-4 py-3 text-xs font-semibold text-slate-500">–ë–∞–ª–ª</th>
                                <th class="text-left px-4 py-3 text-xs font-semibold text-slate-500">–°—Ç–∞—Ç—É—Å</th>
                                <th class="text-left px-4 py-3 text-xs font-semibold text-slate-500"></th>
                            </tr>
                        </thead>
                        <tbody id="calls-table" class="divide-y divide-slate-100">
                            <tr><td colspan="7" class="text-center py-8 text-slate-400">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ==================== TEAM ==================== -->
        <div id="screen-team" class="screen p-4 lg:p-8 space-y-6 hidden fade-in">
            <div>
                <h1 class="text-2xl font-bold text-slate-800">–†–µ–π—Ç–∏–Ω–≥ –∫–æ–º–∞–Ω–¥—ã</h1>
                <p class="text-slate-500 text-sm">–†–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –ø–æ –∫–∞—á–µ—Å—Ç–≤—É</p>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-slate-50 border-b border-slate-100">
                            <tr>
                                <th class="text-left px-4 py-3 text-xs font-semibold text-slate-500 w-16">#</th>
                                <th class="text-left px-4 py-3 text-xs font-semibold text-slate-500">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</th>
                                <th class="text-center px-4 py-3 text-xs font-semibold text-slate-500">–ó–≤–æ–Ω–∫–æ–≤</th>
                                <th class="text-center px-4 py-3 text-xs font-semibold text-slate-500">–ü—Ä–æ–∞–Ω–∞–ª–∏–∑.</th>
                                <th class="text-center px-4 py-3 text-xs font-semibold text-slate-500">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</th>
                                <th class="text-center px-4 py-3 text-xs font-semibold text-slate-500">–£—Å–ø–µ—à–Ω—ã—Ö</th>
                            </tr>
                        </thead>
                        <tbody id="ranking-table" class="divide-y divide-slate-100">
                            <tr><td colspan="6" class="text-center py-8 text-slate-400">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ==================== WHATSAPP ==================== -->
        <div id="screen-whatsapp" class="screen p-4 lg:p-8 space-y-6 hidden fade-in">
            <div class="text-center py-16">
                <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="message-circle" class="w-10 h-10 text-slate-400"></i>
                </div>
                <h2 class="text-xl font-bold text-slate-800 mb-2">WhatsApp –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
                <p class="text-slate-500">–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</p>
            </div>
        </div>
    </main>

    <!-- Mobile Navigation -->
    <nav class="lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 z-30">
        <div class="flex justify-around py-2">
            <button onclick="showScreen('dashboard')" class="mob-nav flex flex-col items-center gap-1 px-2 py-2 text-cyan-600" data-screen="dashboard">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                <span class="text-xs">–î–∞—à–±–æ—Ä–¥</span>
            </button>
            <button onclick="showScreen('calls')" class="mob-nav flex flex-col items-center gap-1 px-2 py-2 text-slate-400" data-screen="calls">
                <i data-lucide="phone-call" class="w-5 h-5"></i>
                <span class="text-xs">–ó–≤–æ–Ω–∫–∏</span>
            </button>
            <button onclick="showScreen('team')" class="mob-nav flex flex-col items-center gap-1 px-2 py-2 text-slate-400" data-screen="team">
                <i data-lucide="trophy" class="w-5 h-5"></i>
                <span class="text-xs">–ö–æ–º–∞–Ω–¥–∞</span>
            </button>
        </div>
    </nav>
</div>

<!-- Call Detail Modal -->
<div id="call-modal" class="modal" onclick="if(event.target===this)closeModal()">
    <div class="bg-white rounded-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col">
        <div class="p-5 border-b border-slate-100 flex items-center justify-between flex-shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-cyan-100 rounded-xl flex items-center justify-center">
                    <i data-lucide="phone-call" class="w-5 h-5 text-cyan-600"></i>
                </div>
                <div>
                    <h2 class="text-lg font-bold text-slate-800" id="modal-title">–ê–Ω–∞–ª–∏–∑ –∑–≤–æ–Ω–∫–∞</h2>
                    <p class="text-sm text-slate-500" id="modal-subtitle"></p>
                </div>
            </div>
            <button onclick="closeModal()" class="p-2 hover:bg-slate-100 rounded-lg">
                <i data-lucide="x" class="w-5 h-5 text-slate-500"></i>
            </button>
        </div>
        <div id="call-modal-content" class="p-5 overflow-y-auto flex-1"></div>
    </div>
</div>

<script>
lucide.createIcons();

let allCalls = [];
let allManagers = [];
let currentPeriod = 'current_week';
let currentManager = 'all';
let currentCallsFilter = 'all';

// ==================== FILTERS ====================

function setPeriod(period) {
    currentPeriod = period;
    applyFilters();
}

function getDateRange(period) {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    let startDate, endDate;
    
    switch(period) {
        case 'today':
            startDate = today;
            endDate = new Date(today.getTime() + 24*60*60*1000 - 1);
            break;
        case 'yesterday':
            startDate = new Date(today.getTime() - 24*60*60*1000);
            endDate = new Date(today.getTime() - 1);
            break;
        case 'current_week':
            const dayOfWeek = today.getDay();
            const monday = new Date(today);
            monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
            startDate = monday;
            endDate = now;
            break;
        case 'last_7_days':
            startDate = new Date(today.getTime() - 7*24*60*60*1000);
            endDate = now;
            break;
        case 'current_month':
            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            endDate = now;
            break;
        case 'last_30_days':
            startDate = new Date(today.getTime() - 30*24*60*60*1000);
            endDate = now;
            break;
        default:
            return null;
    }
    return { startDate, endDate };
}

function getFilteredCalls() {
    let filtered = [...allCalls];
    
    if (currentManager !== 'all') {
        filtered = filtered.filter(c => c.manager_id === parseInt(currentManager));
    }
    
    const range = getDateRange(currentPeriod);
    if (range) {
        filtered = filtered.filter(c => {
            const callDate = new Date(c.call_date);
            return callDate >= range.startDate && callDate <= range.endDate;
        });
    }
    
    return filtered;
}

function applyFilters() {
    currentManager = document.getElementById('filter-manager').value;
    renderDashboard();
}

// ==================== API ====================

async function loadCalls() {
    try {
        const res = await fetch(`${API_URL}/api/calls`);
        allCalls = await res.json();
        renderFilteredCalls();
        renderDashboard();
    } catch (e) {
        console.error('Error loading calls:', e);
    }
}

async function loadManagers() {
    try {
        const res = await fetch(`${API_URL}/api/managers`);
        allManagers = await res.json();
        
        const select = document.getElementById('filter-manager');
        const callsSelect = document.getElementById('calls-filter-manager');
        
        const options = '<option value="all">–í—Å–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã</option>' + 
            allManagers.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
        
        select.innerHTML = options;
        if (callsSelect) callsSelect.innerHTML = options;
        
        renderTeam();
    } catch (e) {
        console.error('Error loading managers:', e);
    }
}

async function analyzeCall(callId) {
    const btn = document.querySelector(`[data-call-id="${callId}"]`);
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin"></i>';
        lucide.createIcons();
    }
    
    try {
        const res = await fetch(`${API_URL}/api/analyze/${callId}`, { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
            await new Promise(r => setTimeout(r, 1000));
            await loadCalls();
            await showCallDetail(callId);
            return true;
        } else {
            alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            return false;
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message);
        return false;
    } finally {
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<i data-lucide="sparkles" class="w-4 h-4"></i>';
            lucide.createIcons();
        }
    }
}

async function reanalyzeCall(callId) {
    const btn = document.getElementById('btn-reanalyze');
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin inline mr-2"></i>–ü–µ—Ä–µ–∞–Ω–∞–ª–∏–∑...';
        lucide.createIcons();
    }
    
    try {
        const res = await fetch(`${API_URL}/api/reanalyze/${callId}`, { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
            await new Promise(r => setTimeout(r, 500));
            await loadCalls();
            await showCallDetail(callId);
        } else {
            alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message);
    } finally {
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<i data-lucide="refresh-cw" class="w-4 h-4 inline mr-2"></i>–ü–µ—Ä–µ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å';
            lucide.createIcons();
        }
    }
}

async function analyzeAllCalls() {
    const btn = document.getElementById('btn-analyze-all');
    btn.disabled = true;
    btn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> –ê–Ω–∞–ª–∏–∑...';
    
    const unanalyzed = allCalls.filter(c => c.audio_url && !c.scores);
    
    if (!unanalyzed.length) {
        alert('–í—Å–µ –∑–≤–æ–Ω–∫–∏ —É–∂–µ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã!');
        btn.disabled = false;
        btn.innerHTML = '<i data-lucide="sparkles" class="w-4 h-4"></i> –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ';
        lucide.createIcons();
        return;
    }
    
    for (const call of unanalyzed) {
        await analyzeCall(call.id);
        await new Promise(r => setTimeout(r, 2000));
    }
    
    btn.disabled = false;
    btn.innerHTML = '<i data-lucide="sparkles" class="w-4 h-4"></i> –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ';
    lucide.createIcons();
}

// ==================== RENDER ====================

function renderDashboard() {
    const calls = getFilteredCalls();
    const analyzed = calls.filter(c => c.scores);
    
    document.getElementById('stat-total-calls').textContent = calls.length;
    document.getElementById('stat-analyzed').textContent = analyzed.length;
    
    const avgScore = analyzed.length 
        ? Math.round(analyzed.reduce((s, c) => s + (c.scores?.total_score || 0), 0) / analyzed.length)
        : 0;
    document.getElementById('stat-avg-score').textContent = avgScore ? `${avgScore}/100` : '‚Äî';
    
    const successful = analyzed.filter(c => c.scores?.total_score >= 80).length;
    document.getElementById('stat-successful').textContent = successful;
    
    const callsWithDuration = calls.filter(c => c.duration > 0);
    if (callsWithDuration.length) {
        const avgDuration = Math.round(callsWithDuration.reduce((s, c) => s + c.duration, 0) / callsWithDuration.length);
        const min = Math.floor(avgDuration / 60);
        const sec = avgDuration % 60;
        document.getElementById('stat-avg-duration').textContent = `${min}:${sec.toString().padStart(2, '0')}`;
    } else {
        document.getElementById('stat-avg-duration').textContent = '‚Äî';
    }
    
    renderCriteriaBreakdown(analyzed);
    renderProblemCalls(analyzed.filter(c => c.scores?.total_score < 60));
    renderRecentAnalyzed(analyzed.slice(0, 5));
}

function renderCriteriaBreakdown(analyzed) {
    const container = document.getElementById('criteria-breakdown');
    
    if (!analyzed.length) {
        container.innerHTML = '<p class="text-center py-4 text-slate-400 col-span-full text-sm">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
        return;
    }
    
    const blocks = [
        { key: 'block1_score', name: '–ö–æ–Ω—Ç–∞–∫—Ç' },
        { key: 'block2_score', name: '–ë–æ–ª—å' },
        { key: 'block3_score', name: '–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è' },
        { key: 'block4_score', name: '–ó–∞–ø–∏—Å—å' },
        { key: 'block5_score', name: '–í–æ–∑—Ä–∞–∂–µ–Ω–∏—è' },
        { key: 'block6_score', name: '–§–∏–Ω–∞–ª' }
    ];
    
    container.innerHTML = blocks.map(bl => {
        const validCalls = analyzed.filter(c => c.scores?.[bl.key] != null);
        const avg = validCalls.length ? Math.round(validCalls.reduce((s, c) => s + (c.scores?.[bl.key] || 0), 0) / validCalls.length) : 0;
        const colorClass = avg >= 80 ? 'text-emerald-600' : avg >= 60 ? 'text-amber-600' : 'text-red-600';
        const bgClass = avg >= 80 ? 'bg-emerald-500' : avg >= 60 ? 'bg-amber-500' : 'bg-red-500';
        
        return `
            <div class="bg-slate-50 rounded-xl p-3 text-center">
                <p class="text-xs text-slate-500 mb-1">${bl.name}</p>
                <p class="text-2xl font-bold ${colorClass}">${avg}</p>
                <div class="mt-2 bg-slate-200 rounded-full h-1.5">
                    <div class="${bgClass} h-1.5 rounded-full" style="width:${avg}%"></div>
                </div>
            </div>
        `;
    }).join('');
}

function renderProblemCalls(calls) {
    const container = document.getElementById('problem-calls');
    
    if (!calls.length) {
        container.innerHTML = '<p class="text-center py-4 text-emerald-600 text-sm">–ù–µ—Ç –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∑–≤–æ–Ω–∫–æ–≤!</p>';
        return;
    }
    
    container.innerHTML = calls.slice(0, 5).map(call => `
        <div onclick="showCallDetail(${call.id})" class="flex items-center gap-3 p-3 rounded-xl bg-red-50 cursor-pointer hover:bg-red-100">
            <div class="w-12 h-12 rounded-xl bg-red-500 flex items-center justify-center text-white font-bold">${call.scores?.total_score || 0}</div>
            <div class="flex-1 min-w-0">
                <p class="font-medium text-slate-800 text-sm">${call.manager?.name || '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä'}</p>
                <p class="text-xs text-red-600 truncate">${call.scores?.ai_summary || ''}</p>
            </div>
        </div>
    `).join('');
}

function renderRecentAnalyzed(calls) {
    const container = document.getElementById('recent-analyzed');
    
    if (!calls.length) {
        container.innerHTML = '<p class="text-center py-4 text-slate-400 text-sm">–ù–µ—Ç –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–≤–æ–Ω–∫–æ–≤</p>';
        return;
    }
    
    container.innerHTML = calls.map(call => {
        const score = call.scores?.total_score || 0;
        const gradient = score >= 80 ? 'from-emerald-500 to-emerald-600' : score >= 60 ? 'from-amber-500 to-amber-600' : 'from-red-500 to-red-600';
        
        return `
            <div onclick="showCallDetail(${call.id})" class="flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 cursor-pointer">
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br ${gradient} flex items-center justify-center text-white font-bold">${score}</div>
                <div class="flex-1 min-w-0">
                    <p class="font-medium text-slate-800 text-sm">${call.manager?.name || '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä'}</p>
                    <p class="text-xs text-slate-500 truncate">${call.scores?.ai_summary || ''}</p>
                </div>
            </div>
        `;
    }).join('');
}

// ==================== CALLS TABLE ====================

function setCallsFilter(filter) {
    currentCallsFilter = filter;
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`filter-${filter}`).classList.add('active');
    renderFilteredCalls();
}

function renderFilteredCalls() {
    let filtered = [...allCalls];
    
    const selectedManager = document.getElementById('calls-filter-manager')?.value || 'all';
    if (selectedManager !== 'all') {
        filtered = filtered.filter(c => c.manager_id === parseInt(selectedManager));
    }
    
    if (currentCallsFilter === 'problem') {
        filtered = filtered.filter(c => c.scores && c.scores.total_score < 60);
    } else if (currentCallsFilter === 'success') {
        filtered = filtered.filter(c => c.scores && c.scores.total_score >= 80);
    } else if (currentCallsFilter === 'unanalyzed') {
        filtered = filtered.filter(c => !c.scores && c.audio_url);
    }
    
    renderCallsTable(filtered);
}

function renderCallsTable(calls) {
    const tbody = document.getElementById('calls-table');
    
    if (!calls.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-slate-400">–ù–µ—Ç –∑–≤–æ–Ω–∫–æ–≤</td></tr>';
        return;
    }
    
    tbody.innerHTML = calls.map(call => {
        const score = call.scores?.total_score;
        const hasAudio = !!call.audio_url;
        const isAnalyzed = score !== undefined;
        
        const scoreColor = score >= 80 ? 'text-emerald-600 bg-emerald-50' : 
                          score >= 60 ? 'text-amber-600 bg-amber-50' : 
                          score ? 'text-red-600 bg-red-50' : 'text-slate-400 bg-slate-50';
        
        const statusBadge = isAnalyzed 
            ? `<span class="px-2 py-1 rounded-full text-xs font-medium ${score >= 80 ? 'bg-emerald-100 text-emerald-700' : score >= 60 ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700'}">${score >= 80 ? '–£—Å–ø–µ—à–Ω—ã–π' : score >= 60 ? '–°—Ä–µ–¥–Ω–∏–π' : '–ü—Ä–æ–±–ª–µ–º–Ω—ã–π'}</span>`
            : hasAudio 
                ? '<span class="px-2 py-1 rounded-full text-xs font-medium bg-violet-100 text-violet-700">–û–∂–∏–¥–∞–µ—Ç</span>'
                : '<span class="px-2 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-500">–ù–µ—Ç –∑–∞–ø–∏—Å–∏</span>';
        
        const duration = call.duration ? `${Math.floor(call.duration / 60)}:${(call.duration % 60).toString().padStart(2, '0')}` : '‚Äî';
        const date = call.call_date ? new Date(call.call_date).toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }) : '‚Äî';
        
        return `
            <tr class="hover:bg-slate-50 cursor-pointer" onclick="event.target.closest('button') || ${isAnalyzed ? `showCallDetail(${call.id})` : hasAudio ? `analyzeCall(${call.id})` : 'null'}">
                <td class="px-4 py-3"><p class="font-medium text-slate-800 text-sm">${call.manager?.name || '‚Äî'}</p></td>
                <td class="px-4 py-3"><p class="text-slate-600 text-sm">${call.client_name || '‚Äî'}</p></td>
                <td class="px-4 py-3"><p class="text-slate-500 text-xs">${date}</p></td>
                <td class="px-4 py-3"><p class="text-slate-600 text-sm">${duration}</p></td>
                <td class="px-4 py-3"><span class="px-2.5 py-1 rounded-lg text-sm font-bold ${scoreColor}">${score ?? '‚Äî'}</span></td>
                <td class="px-4 py-3">${statusBadge}</td>
                <td class="px-4 py-3">
                    ${isAnalyzed 
                        ? `<button onclick="showCallDetail(${call.id})" class="p-2 hover:bg-cyan-50 rounded-lg text-cyan-600"><i data-lucide="eye" class="w-4 h-4"></i></button>`
                        : hasAudio 
                            ? `<button onclick="analyzeCall(${call.id})" data-call-id="${call.id}" class="p-2 hover:bg-violet-50 rounded-lg text-violet-600"><i data-lucide="sparkles" class="w-4 h-4"></i></button>`
                            : ''}
                </td>
            </tr>
        `;
    }).join('');
    
    lucide.createIcons();
}

// ==================== TEAM ====================

function renderTeam() {
    const tbody = document.getElementById('ranking-table');
    
    const stats = allManagers.map(m => {
        const calls = allCalls.filter(c => c.manager_id === m.id);
        const analyzed = calls.filter(c => c.scores);
        const avgScore = analyzed.length ? Math.round(analyzed.reduce((s, c) => s + (c.scores?.total_score || 0), 0) / analyzed.length) : null;
        const successful = analyzed.filter(c => c.scores?.total_score >= 80).length;
        return { ...m, totalCalls: calls.length, analyzedCalls: analyzed.length, avgScore, successful };
    }).sort((a, b) => (b.avgScore || 0) - (a.avgScore || 0));
    
    const medals = ['ü•á', 'ü•à', 'ü•â'];
    
    tbody.innerHTML = stats.map((m, i) => {
        const medal = m.avgScore && i < 3 ? medals[i] : '';
        const scoreColor = m.avgScore >= 80 ? 'text-emerald-600' : m.avgScore >= 60 ? 'text-amber-600' : m.avgScore ? 'text-red-600' : 'text-slate-400';
        
        return `
            <tr class="hover:bg-slate-50">
                <td class="px-4 py-4"><span class="text-lg font-bold text-slate-400">${medal || (i + 1)}</span></td>
                <td class="px-4 py-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-cyan-400 to-cyan-600 flex items-center justify-center text-white font-bold text-sm">
                            ${m.name.split(' ').map(n => n[0]).join('').slice(0, 2)}
                        </div>
                        <p class="font-medium text-slate-800">${m.name}</p>
                    </div>
                </td>
                <td class="px-4 py-4 text-center text-slate-600">${m.totalCalls}</td>
                <td class="px-4 py-4 text-center text-slate-600">${m.analyzedCalls}</td>
                <td class="px-4 py-4 text-center"><span class="text-xl font-bold ${scoreColor}">${m.avgScore ?? '‚Äî'}</span></td>
                <td class="px-4 py-4 text-center text-emerald-600 font-medium">${m.successful}</td>
            </tr>
        `;
    }).join('');
}

// ==================== CALL DETAIL MODAL ====================

async function showCallDetail(callId) {
    const modal = document.getElementById('call-modal');
    const content = document.getElementById('call-modal-content');
    
    content.innerHTML = '<div class="flex justify-center py-12"><i data-lucide="loader" class="w-8 h-8 text-cyan-600 animate-spin"></i></div>';
    lucide.createIcons();
    modal.classList.add('active');
    
    try {
        const res = await fetch(`${API_URL}/api/calls/${callId}`);
        const call = await res.json();
        const score = call.scores;
        
        document.getElementById('modal-title').textContent = call.manager?.name || '–ó–≤–æ–Ω–æ–∫ #' + callId;
        document.getElementById('modal-subtitle').textContent = call.client_name || '';
        
        const gradient = score?.total_score >= 80 ? 'from-emerald-400 to-emerald-600' : 
                        score?.total_score >= 60 ? 'from-amber-400 to-amber-600' : 'from-red-400 to-red-600';
        
        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ
        const clientInfo = score?.client_info || {};
        const clientInfoHtml = score ? `
            <div class="bg-blue-50 rounded-xl p-5">
                <div class="flex items-center gap-2 mb-4">
                    <i data-lucide="user" class="w-5 h-5 text-blue-600"></i>
                    <h3 class="font-semibold text-blue-800">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞—Ü–∏–µ–Ω—Ç–µ</h3>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-white rounded-lg p-3">
                        <p class="text-xs text-slate-500 mb-1">üìã –§–∞–∫—Ç—ã</p>
                        <ul class="text-sm text-slate-700 space-y-1">
                            ${(clientInfo.facts || []).map(f => `<li>‚Ä¢ ${f}</li>`).join('') || '<li class="text-slate-400">–ù–µ –≤—ã—è–≤–ª–µ–Ω–æ</li>'}
                        </ul>
                    </div>
                    <div class="bg-white rounded-lg p-3">
                        <p class="text-xs text-slate-500 mb-1">üéØ –ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏</p>
                        <ul class="text-sm text-slate-700 space-y-1">
                            ${(clientInfo.needs || []).map(n => `<li>‚Ä¢ ${n}</li>`).join('') || '<li class="text-slate-400">–ù–µ –≤—ã—è–≤–ª–µ–Ω–æ</li>'}
                        </ul>
                    </div>
                    <div class="bg-white rounded-lg p-3">
                        <p class="text-xs text-slate-500 mb-1">üòü –ë–æ–ª–∏</p>
                        <ul class="text-sm text-slate-700 space-y-1">
                            ${(clientInfo.pains || []).map(p => `<li>‚Ä¢ ${p}</li>`).join('') || '<li class="text-slate-400">–ù–µ –≤—ã—è–≤–ª–µ–Ω–æ</li>'}
                        </ul>
                    </div>
                    <div class="bg-white rounded-lg p-3">
                        <p class="text-xs text-slate-500 mb-1">ü§î –í–æ–∑—Ä–∞–∂–µ–Ω–∏—è</p>
                        <ul class="text-sm text-slate-700 space-y-1">
                            ${(clientInfo.objections || []).map(o => `<li>‚Ä¢ ${o}</li>`).join('') || '<li class="text-slate-400">–ù–µ –±—ã–ª–æ</li>'}
                        </ul>
                    </div>
                </div>
            </div>
        ` : '';
        
        // –ë–ª–æ–∫–∏ —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏—è–º–∏
        const explanations = score?.score_explanations || {};
        const blocksHtml = score ? `
            <div class="bg-slate-50 rounded-xl p-5">
                <h3 class="font-semibold text-slate-800 mb-4">–û—Ü–µ–Ω–∫–∞ –ø–æ –±–ª–æ–∫–∞–º</h3>
                <div class="space-y-3">
                    ${renderBlockWithExplanation('–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞', score.block1_score, explanations.block1, 1)}
                    ${renderBlockWithExplanation('–í—ã—è–≤–ª–µ–Ω–∏–µ –±–æ–ª–∏', score.block2_score, explanations.block2, 2)}
                    ${renderBlockWithExplanation('–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è —Ä–µ—à–µ–Ω–∏—è', score.block3_score, explanations.block3, 3)}
                    ${renderBlockWithExplanation('–ó–∞–ø–∏—Å—å', score.block4_score, explanations.block4, 4)}
                    ${renderBlockWithExplanation('–û—Ç—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–π', score.block5_score, explanations.block5, 5)}
                    ${renderBlockWithExplanation('–§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è', score.block6_score, explanations.block6, 6)}
                </div>
            </div>
        ` : '';
        
        // –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç —Å —Ä–æ–ª—è–º–∏
        const transcriptFormatted = call.transcript_formatted || [];
        const transcriptHtml = transcriptFormatted.length > 0 ? `
            <div class="bg-slate-50 rounded-xl p-5">
                <div class="flex items-center gap-2 mb-3">
                    <i data-lucide="message-square" class="w-5 h-5 text-slate-600"></i>
                    <h3 class="font-semibold text-slate-800">–î–∏–∞–ª–æ–≥</h3>
                </div>
                <div class="space-y-2 max-h-80 overflow-y-auto">
                    ${transcriptFormatted.map(r => `
                        <div class="p-3 rounded-lg ${r.role === 'manager' ? 'transcript-manager' : 'transcript-client'}">
                            <p class="text-xs font-medium ${r.role === 'manager' ? 'text-green-700' : 'text-blue-700'} mb-1">
                                ${r.role === 'manager' ? 'üë®‚Äçüíº –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : 'üë§ –ü–∞—Ü–∏–µ–Ω—Ç'}
                            </p>
                            <p class="text-sm text-slate-700">${r.text}</p>
                        </div>
                    `).join('')}
                </div>
            </div>
        ` : call.transcript ? `
            <div class="bg-slate-50 rounded-xl p-5">
                <div class="flex items-center gap-2 mb-3">
                    <i data-lucide="file-text" class="w-5 h-5 text-slate-600"></i>
                    <h3 class="font-semibold text-slate-800">–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç</h3>
                </div>
                <div class="bg-white rounded-lg p-4 max-h-64 overflow-y-auto border">
                    <p class="text-sm text-slate-600 whitespace-pre-wrap">${call.transcript}</p>
                </div>
            </div>
        ` : '';
        
        // –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∞–Ω–∞–ª–∏–∑–∞
        const reanalyzeBtn = call.audio_url ? `
            <button id="btn-reanalyze" onclick="reanalyzeCall(${call.id})" 
                class="flex items-center justify-center gap-2 w-full py-3 bg-amber-50 text-amber-700 border border-amber-200 rounded-xl font-medium hover:bg-amber-100 transition-colors">
                <i data-lucide="refresh-cw" class="w-4 h-4"></i>–ü–µ—Ä–µ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
            </button>
        ` : '';
        
        content.innerHTML = `
            <div class="space-y-6">
                ${score ? `
                    <div class="bg-gradient-to-r ${gradient} rounded-2xl p-6 text-white text-center">
                        <div class="text-5xl font-bold mb-2">${score.total_score}</div>
                        <p class="text-white/80">${score.is_successful ? '–ü–∞—Ü–∏–µ–Ω—Ç –∑–∞–ø–∏—Å–∞–Ω' : '–ó–∞–ø–∏—Å—å –Ω–µ —Å–æ—Å—Ç–æ—è–ª–∞—Å—å'}</p>
                        <p class="text-white/60 text-sm mt-1">${score.call_type || ''}</p>
                    </div>
                    
                    ${clientInfoHtml}
                    
                    ${blocksHtml}
                    
                    <div class="bg-violet-50 rounded-xl p-5">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="sparkles" class="w-5 h-5 text-violet-600"></i>
                            <h3 class="font-semibold text-violet-800">–í—ã–≤–æ–¥ –ò–ò</h3>
                        </div>
                        <p class="text-violet-700">${score.ai_summary || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</p>
                    </div>
                ` : `
                    <div class="text-center py-4">
                        <p class="text-slate-500 mb-4">–ó–≤–æ–Ω–æ–∫ –Ω–µ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω</p>
                        ${call.audio_url ? `
                            <button onclick="analyzeCall(${call.id})" data-call-id="${call.id}" class="px-6 py-3 bg-violet-600 text-white rounded-xl font-medium hover:bg-violet-700">
                                <i data-lucide="sparkles" class="w-4 h-4 inline mr-2"></i>–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                        ` : '<p class="text-sm text-slate-400">–ù–µ—Ç –∑–∞–ø–∏—Å–∏ –∑–≤–æ–Ω–∫–∞</p>'}
                    </div>
                `}
                
                ${transcriptHtml}
                
                ${call.audio_url ? `
                    <div class="bg-slate-50 rounded-xl p-5">
                        <div class="flex items-center gap-2 mb-3">
                            <i data-lucide="headphones" class="w-5 h-5 text-slate-600"></i>
                            <h3 class="font-semibold text-slate-800">–ó–∞–ø–∏—Å—å –∑–≤–æ–Ω–∫–∞</h3>
                        </div>
                        <audio controls class="w-full" src="${call.audio_url}"></audio>
                    </div>
                ` : ''}
                
                <div class="flex flex-col gap-3">
                    ${reanalyzeBtn}
                    ${call.crm_link ? `
                        <a href="${call.crm_link}" target="_blank" class="flex items-center justify-center gap-2 w-full py-3 bg-cyan-600 text-white rounded-xl font-medium hover:bg-cyan-700">
                            <i data-lucide="external-link" class="w-4 h-4"></i>–û—Ç–∫—Ä—ã—Ç—å –≤ –ë–∏—Ç—Ä–∏–∫—Å24
                        </a>
                    ` : ''}
                </div>
            </div>
        `;
        
        lucide.createIcons();
    } catch (e) {
        content.innerHTML = `<p class="text-center py-8 text-red-500">–û—à–∏–±–∫–∞: ${e.message}</p>`;
    }
}

function renderBlockWithExplanation(name, score, explanation, blockNum) {
    if (score == null) return '';
    
    const scoreColor = score >= 80 ? 'text-emerald-600' : score >= 60 ? 'text-amber-600' : 'text-red-600';
    const barColor = score >= 80 ? 'bg-emerald-500' : score >= 60 ? 'bg-amber-500' : 'bg-red-500';
    
    return `
        <div class="bg-white rounded-lg p-4">
            <div class="expand-btn flex justify-between items-center" onclick="toggleExplanation(${blockNum})">
                <span class="text-sm font-medium text-slate-700">${name}</span>
                <div class="flex items-center gap-2">
                    <span class="text-sm font-bold ${scoreColor}">${score}/100</span>
                    <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400 transition-transform" id="chevron-${blockNum}"></i>
                </div>
            </div>
            <div class="mt-2 bg-slate-100 rounded-full h-2">
                <div class="${barColor} h-2 rounded-full" style="width:${score}%"></div>
            </div>
            <div class="expandable mt-3" id="explanation-${blockNum}">
                <p class="text-sm text-slate-600 bg-slate-50 p-3 rounded-lg">${explanation || '–ù–µ—Ç –æ–±—ä—è—Å–Ω–µ–Ω–∏—è'}</p>
            </div>
        </div>
    `;
}

function toggleExplanation(blockNum) {
    const el = document.getElementById(`explanation-${blockNum}`);
    const chevron = document.getElementById(`chevron-${blockNum}`);
    el.classList.toggle('open');
    chevron.style.transform = el.classList.contains('open') ? 'rotate(180deg)' : '';
}

function closeModal() {
    document.getElementById('call-modal').classList.remove('active');
}

function showScoreDetail() {
    alert('–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
}

// ==================== NAVIGATION ====================

function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
    document.getElementById('screen-' + id).classList.remove('hidden');
    
    document.querySelectorAll('.nav-btn').forEach(b => {
        b.classList.remove('nav-active');
        b.classList.add('nav-inactive');
    });
    document.getElementById('nav-' + id)?.classList.remove('nav-inactive');
    document.getElementById('nav-' + id)?.classList.add('nav-active');
    
    document.querySelectorAll('.mob-nav').forEach(b => {
        b.classList.remove('text-cyan-600');
        b.classList.add('text-slate-400');
    });
    document.querySelector(`.mob-nav[data-screen="${id}"]`)?.classList.remove('text-slate-400');
    document.querySelector(`.mob-nav[data-screen="${id}"]`)?.classList.add('text-cyan-600');
    
    lucide.createIcons();
    window.scrollTo(0, 0);
}

// ==================== INIT ====================

document.addEventListener('DOMContentLoaded', async () => {
    await loadCalls();
    await loadManagers();
});
</script>

</body>
</html>
